{% extends 'quiz/base.html' %}

{% block title %}Take Quiz - {{ quiz.title }}{% endblock %}

{% block extra_css %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700;800&display=swap');
    
    * {
        font-family: 'Inter', sans-serif;
    }
    
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6 {
        font-family: 'Playfair Display', serif;
    }
    
    /* Animated gradient background */
    .animated-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
    }
    
    @keyframes gradientShift {
        0%, 100% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
    }
    
    /* Floating shapes */
    .floating-shape {
        position: fixed;
        border-radius: 50%;
        opacity: 0.15;
        animation: float 20s infinite ease-in-out;
    }
    
    .shape-1 {
        width: 100px;
        height: 100px;
        background: white;
        top: 10%;
        left: 10%;
        animation-delay: 0s;
    }
    
    .shape-2 {
        width: 80px;
        height: 80px;
        background: white;
        top: 60%;
        right: 15%;
        animation-delay: 3s;
    }
    
    .shape-3 {
        width: 60px;
        height: 60px;
        background: white;
        bottom: 20%;
        left: 30%;
        animation-delay: 6s;
    }
    
    @keyframes float {
        0%, 100% {
            transform: translateY(0) rotate(0deg);
        }
        50% {
            transform: translateY(-30px) rotate(180deg);
        }
    }
    
    /* Enhanced card styling */
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 25px;
        padding: 35px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        overflow: hidden;
        animation: cardReveal 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(102, 126, 234, 0.15),
            transparent
        );
        animation: shimmer 3s infinite;
    }
    
    @keyframes shimmer {
        0% {
            left: -100%;
        }
        100% {
            left: 100%;
        }
    }
    
    @keyframes cardReveal {
        from {
            transform: translateY(30px) scale(0.95);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    
    /* Enhanced question container animations */
    .question-container {
        display: none;
        animation: fadeIn 0.5s ease-out;
    }
    
    .question-container.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    /* Show first question by default as fallback */
    .question-container:first-child {
        display: block;
    }
    
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        gap: 15px;
    }
    
    .option-label {
        display: block;
        padding: 20px;
        margin-bottom: 15px;
        border: 2px solid transparent;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        background: #f8fafc;
        position: relative;
        overflow: hidden;
    }
    
    .option-label::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .option-label:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #667eea;
    }
    
    .option-label:hover::before {
        opacity: 1;
    }
    
    .option-label input[type="radio"] {
        margin-right: 15px;
        transform: scale(1.3);
        accent-color: #667eea;
    }
    
    .option-label.selected {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .question-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 25px;
        justify-content: center;
    }
    
    .question-nav button {
        width: 45px;
        height: 45px;
        border: 2px solid #cbd5e0;
        background: white;
        border-radius: 50%;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .question-nav button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0));
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .question-nav button:hover {
        transform: translateY(-3px) scale(1.1);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    .question-nav button:hover::before {
        opacity: 1;
    }
    
    .question-nav button.answered {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border-color: #059669;
    }
    
    .question-nav button.unanswered {
        background: linear-gradient(135deg, #94a3b8, #64748b);
        color: white;
        border-color: #64748b;
    }
    
    .question-nav button.current {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
        transform: scale(1.15);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    /* Timer styling */
    #timer {
        font-size: 1.4rem;
        font-weight: 800;
        color: #e53e3e;
        text-shadow: 0 2px 10px rgba(229, 62, 62, 0.3);
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
    
    /* Exit button styling */
    .exit-btn {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 50px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .exit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.6);
    }
    
    .exit-btn:active {
        transform: translateY(-1px);
    }
    
    /* Toast notifications */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast.show {
        transform: translateX(0);
    }
    
    .toast.success {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .toast.error {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    /* Confirmation Modal */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 9999;
        animation: fadeInModal 0.3s ease-out;
    }
    
    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    @keyframes fadeInModal {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
    
    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        text-align: center;
    }
    
    @keyframes modalSlideIn {
        from {
            transform: scale(0.7) translateY(-50px);
            opacity: 0;
        }
        to {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
    }
    
    .modal-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        animation: iconBounceModal 1s infinite;
    }
    
    @keyframes iconBounceModal {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px);
        }
    }
    
    .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 15px;
        font-family: 'Playfair Display', serif;
    }
    
    .modal-message {
        font-size: 1.1rem;
        color: #718096;
        margin-bottom: 30px;
        line-height: 1.6;
    }
    
    .modal-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
    }
    
    .modal-btn {
        padding: 12px 30px;
        border: none;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: 'Inter', sans-serif;
    }
    
    .modal-btn-confirm {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }
    
    .modal-btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(17, 153, 142, 0.6);
    }
    
    .modal-btn-cancel {
        background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(113, 128, 150, 0.4);
    }
    
    .modal-btn-cancel:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(113, 128, 150, 0.6);
    }
    
    .modal-btn-exit {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
    }
    
    .modal-btn-exit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6);
    }
</style>
{% endblock %}

{% block content %}
<!-- Animated background -->
<div class="animated-bg"></div>
<div class="floating-shape shape-1"></div>
<div class="floating-shape shape-2"></div>
<div class="floating-shape shape-3"></div>

<!-- Toast notifications -->
<div id="toast-success" class="toast success">
    <span>‚úÖ</span>
    <span>Quiz submitted successfully!</span>
</div>

<div id="toast-error" class="toast error">
    <span>‚ùå</span>
    <span>Submission cancelled!</span>
</div>

<!-- Confirmation Modal for Submit -->
<div class="modal-overlay" id="confirmModal">
    <div class="modal-content">
        <div class="modal-icon">‚ùì</div>
        <div class="modal-title">Confirm Submission</div>
        <div class="modal-message">Are you sure you want to submit this quiz?<br>You cannot change your answers after submission.</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="submitQuiz()">Yes, Submit</button>
            <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Confirmation Modal for Exit -->
<div class="modal-overlay" id="exitModal">
    <div class="modal-content">
        <div class="modal-icon">üö™</div>
        <div class="modal-title">Exit Quiz</div>
        <div class="modal-message">Are you sure you want to exit the quiz?<br>This will submit your current answers.</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-exit" onclick="exitQuiz()">Yes, Exit</button>
            <button class="modal-btn modal-btn-cancel" onclick="closeExitModal()">Cancel</button>
        </div>
    </div>
</div>

<h2 style="margin-bottom: 20px; color: #2d3748; text-align: center; font-size: 2rem; animation: titleReveal 1s cubic-bezier(0.34, 1.56, 0.64, 1);">
    {{ quiz.title }}
</h2>

<div class="card">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <div style="font-size: 1.1rem; font-weight: 600; color: #4a5568;">
            <strong>‚è±Ô∏è Time Limit:</strong> {{ quiz.time_limit }} minutes
        </div>
        <div id="timer" style="font-size: 1.4rem; font-weight: 800; color: #e53e3e;">
            ‚è∞ Time Remaining: <span id="timeDisplay">{{ quiz.time_limit }}:00</span>
        </div>
        <button class="exit-btn" onclick="confirmExit()">
            <span>üö™</span>
            <span>Exit Quiz</span>
        </button>
    </div>
    
    <div class="question-nav" id="questionNav"></div>
    
    <form method="post" action="{% url 'submit_quiz' attempt.id %}" id="quizForm">
        {% csrf_token %}
        
        {% for question in questions %}
        <div class="question-container{% if forloop.first %} active{% endif %}" id="question-{{ question.id }}" data-question-id="{{ question.id }}">
            <h3 style="margin-bottom: 20px; color: #2d3748; font-size: 1.5rem; animation: questionReveal 0.6s ease-out;">
                Question {{ forloop.counter }}  {{ questions.count }}
            </h3>
            <p style="font-size: 1.2rem; margin-bottom: 25px; color: #374151; line-height: 1.6; animation: textReveal 0.8s ease-out;">
                {{ question.question_text }}
            </p>
            
            <div>
                <label class="option-label">
                    <input type="radio" name="question_{{ question.id }}" value="A">
                    <strong>A.</strong> {{ question.option_a }}
                </label>
                
                <label class="option-label">
                    <input type="radio" name="question_{{ question.id }}" value="B">
                    <strong>B.</strong> {{ question.option_b }}
                </label>
                
                <label class="option-label">
                    <input type="radio" name="question_{{ question.id }}" value="C">
                    <strong>C.</strong> {{ question.option_c }}
                </label>
                
                <label class="option-label">
                    <input type="radio" name="question_{{ question.id }}" value="D">
                    <strong>D.</strong> {{ question.option_d }}
                </label>
            </div>
            
            <div class="navigation-buttons">
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn-{{ question.id }}">
                        ‚Üê Previous
                    </button>
                    
                    <button type="button" class="btn btn-warning" onclick="clearResponse({{ question.id }})" id="clearBtn-{{ question.id }}">
                        üßπ Clear Response
                    </button>
                </div>
                
                {% if forloop.last %}
                <button type="button" class="btn btn-success" onclick="confirmSubmit()">
                    ‚úÖ Submit Quiz
                </button>
                {% else %}
                <button type="button" class="btn btn-primary" onclick="nextQuestion()">
                    Next ‚Üí
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Store question IDs in order
let questionIds = [];
{% for question in questions %}
questionIds.push({{ question.id }});
{% endfor %}

// If no questions were added via template, try to extract from DOM
if (questionIds.length === 0) {
    document.querySelectorAll('.question-container').forEach(container => {
        const questionId = container.id.replace('question-', '');
        if (questionId && !isNaN(questionId)) {
            questionIds.push(parseInt(questionId));
        }
    });
}

let currentQuestionIndex = 0;
const totalQuestions = questionIds.length;
let timeRemaining = {{ quiz.time_limit }} * 60; // in seconds

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Make sure we have questions before initializing
    if (questionIds.length > 0) {
        showQuestionByIndex(0);
        updateQuestionNav();
        startTimer();
    }
    
    // Add event listeners to all radio buttons
    const radios = document.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Add selected class to parent label
            document.querySelectorAll('.option-label').forEach(label => {
                label.classList.remove('selected');
            });
            
            if (this.checked) {
                this.closest('.option-label').classList.add('selected');
            }
            
            updateQuestionNav();
        });
    });
    
    // Add selected class to already checked radio buttons
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        radio.closest('.option-label').classList.add('selected');
    });
});

function showQuestionByIndex(index) {
    // Validate index
    if (index < 0 || index >= questionIds.length) {
        return;
    }
    
    // Hide all questions
    document.querySelectorAll('.question-container').forEach(q => {
        q.classList.remove('active');
    });
    
    // Show current question
    const questionId = questionIds[index];
    const questionDiv = document.getElementById('question-' + questionId);
    
    if (questionDiv) {
        questionDiv.classList.add('active');
        currentQuestionIndex = index;
        updateQuestionNav();
        
        // Add animation to question elements
        const questionTitle = questionDiv.querySelector('h3');
        const questionText = questionDiv.querySelector('p');
        const options = questionDiv.querySelectorAll('.option-label');
        
        if (questionTitle) questionTitle.style.animation = 'none';
        if (questionText) questionText.style.animation = 'none';
        options.forEach(option => option.style.animation = 'none');
        
        // Trigger reflow
        void questionTitle.offsetWidth;
        void questionText.offsetWidth;
        options.forEach(option => void option.offsetWidth);
        
        // Reapply animations
        if (questionTitle) questionTitle.style.animation = 'questionReveal 0.6s ease-out';
        if (questionText) questionText.style.animation = 'textReveal 0.8s ease-out';
        options.forEach((option, i) => {
            option.style.animation = 'none';
            void option.offsetWidth;
            option.style.animation = `fadeIn 0.5s ease-out ${i * 0.1}s both`;
        });
    }
}

function nextQuestion() {
    if (currentQuestionIndex < totalQuestions - 1) {
        showQuestionByIndex(currentQuestionIndex + 1);
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        showQuestionByIndex(currentQuestionIndex - 1);
    }
}

function clearResponse(questionId) {
    // Clear the selected radio button for the current question
    const questionDiv = document.querySelector(`.question-container.active`);
    const radios = questionDiv.querySelectorAll('input[type="radio"]');
    radios.forEach(radio => {
        radio.checked = false;
    });
    
    // Remove selected class from labels
    const labels = questionDiv.querySelectorAll('.option-label');
    labels.forEach(label => {
        label.classList.remove('selected');
    });
    
    // Update the navigation buttons to reflect the cleared response
    updateQuestionNav();
}

function updateQuestionNav() {
    const navDiv = document.getElementById('questionNav');
    if (!navDiv) return; // Safety check
    
    navDiv.innerHTML = '';
    
    for (let i = 0; i < totalQuestions; i++) {
        const questionId = questionIds[i];
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = i + 1;
        btn.onclick = () => showQuestionByIndex(i);
        
        // Check if question is answered
        const questionDiv = document.getElementById('question-' + questionId);
        if (questionDiv) {
            const radios = questionDiv.querySelectorAll('input[type="radio"]');
            let isAnswered = false;
            radios.forEach(radio => {
                if (radio && radio.checked) isAnswered = true;
            });
            
            if (isAnswered) {
                btn.classList.add('answered');
            } else {
                btn.classList.add('unanswered');
            }
        }
        
        if (i === currentQuestionIndex) {
            btn.classList.add('current');
        }
        
        navDiv.appendChild(btn);
    }
}

function startTimer() {
    const timerInterval = setInterval(() => {
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! The quiz will be submitted automatically.');
            const form = document.getElementById('quizForm');
            if (form) {
                form.submit();
            }
        }
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timeDisplay = document.getElementById('timeDisplay');
        if (timeDisplay) {
            timeDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        }
        
        const timeElement = document.getElementById('timer');
        if (timeElement && timeRemaining <= 60) {
            timeElement.style.color = '#e53e3e';
            timeElement.style.animation = 'pulse 1s infinite';
        }
        
        timeRemaining--;
    }, 1000);
}

function confirmSubmit() {
    const modal = document.getElementById('confirmModal');
    if (modal) {
        modal.classList.add('active');
    }
}

function closeConfirmModal() {
    const modal = document.getElementById('confirmModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function submitQuiz() {
    const form = document.getElementById('quizForm');
    if (form) {
        form.submit();
        showToast('success');
    }
}

// Exit functionality
function confirmExit() {
    const modal = document.getElementById('exitModal');
    if (modal) {
        modal.classList.add('active');
    }
}

function closeExitModal() {
    const modal = document.getElementById('exitModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function exitQuiz() {
    // Submit the quiz when exiting
    submitQuiz();
}

// Toast notifications
function showToast(type) {
    const toast = document.getElementById('toast-' + type);
    if (toast) {
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
}

// Add keyframe animations to document
const style = document.createElement('style');
style.textContent = `
    @keyframes titleReveal {
        from {
            transform: translateY(-30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    @keyframes questionReveal {
        from {
            transform: translateX(-20px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes textReveal {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}